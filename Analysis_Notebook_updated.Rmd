###############################################################################
# Phylogenetic Comparative Analysis Script For Determining Relationship Between Genomic Methylation and Regeneration
###############################################################################

suppressPackageStartupMessages({
  library(ape); library(phytools); library(nlme)
  library(emmeans); library(car); library(dplyr)
  library(rcompanion); library(nortest); library(moments)
  library(ggplot2)
  okCairo <- requireNamespace("Cairo", quietly = TRUE)
})
set.seed(123)

###############################################################################
# 0) Inputs
###############################################################################
base_dir <- "/Users/laurelhiebert/Documents/07. 2024-2025_YiLab_UCSB/04. Review MS/Phylogenetic_comparative_analysis"

tree_calibrated_file <- file.path(base_dir, "Scaled_tree.nwk")                         # 119-tip calibrated tree
tree_grafted_file    <- file.path(base_dir, "grafting", "final_grafted_tree.newick")  # 175-tip grafted tree
data_file            <- file.path(base_dir, "Methylation_data.csv")

out_dir  <- file.path(base_dir, "figures")  # output folder for all SI tables + figs + trees
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)

stopifnot(file.exists(tree_calibrated_file),
          file.exists(tree_grafted_file),
          file.exists(data_file))

cat("\nUsing base directory:\n", base_dir, "\nOutputs will be written to:\n", out_dir, "\n\n")

###############################################################################
# 1) Load & basic cleaning
###############################################################################
traits_raw <- read.csv(data_file, stringsAsFactors = FALSE)
traits_raw <- traits_raw %>% select(Species, Methylation, Regen_Ability)
traits_raw$Species <- tolower(trimws(traits_raw$Species))

# helper: align tree and data
align_tree_and_data <- function(tree, df) {
  tree$tip.label <- tolower(trimws(tree$tip.label))
  # handle duplicate species in trait table (average numeric, keep first non-numeric)
  if (any(duplicated(df$Species))) {
    message("Duplicates detected in data — averaging numeric traits per species.")
    df <- aggregate(. ~ Species, data = df, FUN = function(z) if (is.numeric(z)) mean(z, na.rm = TRUE) else z[1])
  }
  common <- intersect(tree$tip.label, df$Species)
  if (length(common) < 3L) stop("Too few overlapping species (", length(common), ").")
  tree2 <- drop.tip(tree, setdiff(tree$tip.label, common))
  df2   <- df[df$Species %in% common, , drop = FALSE]
  df2   <- df2[match(tree2$tip.label, df2$Species), , drop = FALSE]
  stopifnot(identical(df2$Species, tree2$tip.label))
  list(tree = tree2, data = df2)
}

# helper: safe PDF writer (Cairo if present, otherwise base pdf via ggsave)
save_pdf <- function(gg, path, width_in, height_in) {
  if (okCairo) {
    Cairo::CairoPDF(filename = path, width = width_in, height = height_in)
    print(gg); dev.off()
  } else {
    ggsave(path, plot = gg, width = width_in, height = height_in, units = "in", device = "pdf")
  }
  cat("Saved:", path, "\n")
}

###############################################################################
# 2) Core analysis function for one tree
###############################################################################
run_pgls_analysis <- function(tree_in, df_in, tree_label, fig_suffix, out_dir) {
  cat("=== Running:", tree_label, "===\n")
  tree <- tree_in
  df   <- df_in

  # --- Tree prep ---
  if (is.null(tree$edge.length)) stop("Tree has no branch lengths.")
  tree$edge.length[tree$edge.length < 1e-6] <- 1e-4
  tree <- phytools::force.ultrametric(tree, method = "nnls")

  # --- Transform (Tukey) ---
  lam_tuk <- rcompanion::transformTukey(df$Methylation, returnLambda = TRUE, plotit = FALSE)
  df$Methylation_Tukey <- rcompanion::transformTukey(df$Methylation, returnLambda = FALSE, plotit = FALSE)

  # --- 3-level regeneration factor ---
  df$Regen_3L <- dplyr::recode(as.numeric(df$Regen_Ability),
                               `1`="None", `2`="Partial", `3`="Partial", `4`="WBR",
                               .default = NA_character_)
  df$Regen_3L <- factor(df$Regen_3L, levels = c("None","Partial","WBR"))
  df$Species <- tree$tip.label
  rownames(df) <- df$Species
  stopifnot(identical(df$Species, tree$tip.label))

  # --- Models (PGLS) ---
  corPag <- corPagel(0.5, phy = tree, form = ~Species, fixed = FALSE)
  mod_full <- nlme::gls(Methylation_Tukey ~ Regen_3L,
                        data = df, correlation = corPag, method = "ML")
  mod_null <- nlme::gls(Methylation_Tukey ~ 1,
                        data = df, correlation = corPag, method = "ML")

  comp <- suppressWarnings(anova(mod_null, mod_full))

  # --- Robust LR & p extraction (handles L.Ratio / LR value / Chisq etc.) ---
  LR_cols <- grep("LR|L\\.R|Ratio|Chi", names(comp), ignore.case = TRUE)
  P_cols  <- grep("^p|p[- ]?value|Pr",  names(comp), ignore.case = TRUE)

  LR_value <- if (length(LR_cols) > 0) as.numeric(comp[2, LR_cols[1]]) else NA_real_
  LR_pval  <- if (length(P_cols)  > 0) as.numeric(comp[2, P_cols[1]])  else NA_real_

  if (is.na(LR_value) || is.na(LR_pval)) {
    warning("Could not extract LR or p-value from anova(); printing comp for debugging.")
    print(comp); print(names(comp))
  }

  # --- ΔAIC (safe & explicit) ---
  aic_null <- as.numeric(AIC(mod_null))
  aic_full <- as.numeric(AIC(mod_full))
  delta_aic <- aic_full - aic_null

  # --- Fitted λ ---
  lambda_est <- tryCatch(
    as.numeric(coef(mod_full$modelStruct$corStruct, unconstrained = FALSE)[1]),
    error = function(e) NA_real_
  )

  # --- emmeans & pairwise ---
  emm_obj  <- emmeans::emmeans(mod_full, ~Regen_3L, data = df)
  emm_df   <- as.data.frame(emm_obj)            # emmean, SE, df, lower.CL, upper.CL
  emm_ci   <- as.data.frame(confint(emm_obj))   # ensures lower.CL/upper.CL present
  contr_df <- as.data.frame(pairs(emm_obj, adjust = "none"))

  # --- Residual diagnostics ---
  res <- residuals(mod_full, type = "normalized")
  sh  <- shapiro.test(res)
  ad  <- nortest::ad.test(res)
  lev <- car::leveneTest(res ~ df$Regen_3L)
  res_lambda <- phytools::phylosig(tree, setNames(res, df$Species), method = "lambda", test = TRUE)

  # --- Normality table (raw vs Tukey) ---
  diag_fun <- function(x) data.frame(
    Shapiro_W = unname(shapiro.test(x)$statistic),
    Shapiro_p = shapiro.test(x)$p.value,
    AD_A      = nortest::ad.test(x)$statistic,
    AD_p      = nortest::ad.test(x)$p.value,
    Lillie_D  = nortest::lillie.test(x)$statistic,
    Lillie_p  = nortest::lillie.test(x)$p.value,
    Skewness  = moments::skewness(x, na.rm = TRUE),
    Kurtosis  = moments::kurtosis(x, na.rm = TRUE)
  )
  x_raw <- df$Methylation
  x_tuk <- df$Methylation_Tukey
  norm_tbl <- rbind(
    cbind(Transform = "Raw",   diag_fun(x_raw)),
    cbind(Transform = "Tukey", diag_fun(x_tuk))
  )
  norm_tbl$Tukey_lambda <- c(NA, lam_tuk)

  # --- Phylogenetic signal (raw & Tukey) ---
  names(x_raw) <- names(x_tuk) <- df$Species
  K_raw <- phytools::phylosig(tree, x_raw, method = "K", test = TRUE, nsim = 1000)
  L_raw <- phytools::phylosig(tree, x_raw, method = "lambda", test = TRUE)
  K_tuk <- phytools::phylosig(tree, x_tuk, method = "K", test = TRUE, nsim = 1000)
  L_tuk <- phytools::phylosig(tree, x_tuk, method = "lambda", test = TRUE)
  phy_tbl <- data.frame(
    Transform = c("Raw","Raw","Tukey","Tukey"),
    Metric    = c("Blomberg_K","Pagel_lambda","Blomberg_K","Pagel_lambda"),
    Estimate  = c(K_raw$K, L_raw$lambda, K_tuk$K, L_tuk$lambda),
    P_value   = c(K_raw$P, L_raw$P, K_tuk$P, L_tuk$P)
  )

  # --- SI summary row (clean, no NA where possible) ---
  si_summary <- data.frame(
    Tree             = tree_label,
    Nspecies         = nrow(df),
    Tukey_lambda     = round(lam_tuk, 3),
    Delta_AIC        = round(delta_aic, 3),
    LR               = ifelse(is.finite(LR_value), round(LR_value, 3), NA),
    p_value          = ifelse(is.finite(LR_pval),  signif(LR_pval, 3), NA),
    Lambda_est       = round(lambda_est, 3),
    Residual_lambda  = round(res_lambda$lambda, 3),
    Residual_lambda_p= signif(res_lambda$P, 3),
    Shapiro_p        = signif(sh$p.value, 3),
    AD_p             = signif(ad$p.value, 3),
    Levene_p         = signif(lev$`Pr(>F)`[1], 3),
    check.names = FALSE
  )

  # --- Figure (EMMs ± SE with raw points; same look as yours) ---
  label_map <- c("None" = "None / limited", "Partial" = "Tissue / organ", "WBR" = "Whole-body")
  emm_ci$Regen_3L_labelled <- factor(label_map[emm_ci$Regen_3L],
                                     levels = c("None / limited","Tissue / organ","Whole-body"))
  df$Regen_3L_labelled <- factor(label_map[df$Regen_3L],
                                 levels = c("None / limited","Tissue / organ","Whole-body"))

  p <- ggplot() +
    geom_jitter(data = df,
                aes(Regen_3L_labelled, Methylation_Tukey),
                width = 0.18, alpha = 0.35, size = 1.5, color = "gray35") +
    geom_errorbar(data = emm_ci,
                  aes(Regen_3L_labelled, ymin = lower.CL, ymax = upper.CL),
                  width = 0.10, linewidth = 0.8, color = "black") +
    geom_point(data = emm_ci,
               aes(Regen_3L_labelled, emmean),
               size = 3.3, color = "black") +
    coord_cartesian(ylim = c(0, 5.0), clip = "off") +
    scale_x_discrete(
      limits = c("None / limited","Tissue / organ","Whole-body"),
      labels = c("None /\nlimited","Tissue /\norgan","Whole-body"),
      expand = expansion(mult = c(0.12, 0.12))
    ) +
    labs(x = "Regeneration capacity",
         y = "CpG methylation (Tukey-transformed)",
         title = paste0("PGLS estimated marginal means ± SE — ", tree_label)) +
    theme_classic(base_size = 11, base_family = "Helvetica") +
    theme(plot.title   = element_text(hjust = 0.5, size = 12.5, margin = margin(b = 8)),
          axis.title.x = element_text(size = 12, face = "bold", margin = margin(t = 12)),
          axis.title.y = element_text(size = 12, face = "bold", margin = margin(r = 12)),
          axis.text.x  = element_text(size = 10.5, color = "black", lineheight = 1.1, vjust = 1),
          axis.text.y  = element_text(size = 10.5, color = "black"),
          axis.line    = element_line(linewidth = 0.5),
          axis.ticks   = element_line(linewidth = 0.4),
          plot.margin  = margin(10, 10, 10, 10))

  fig_path <- file.path(out_dir, paste0("PGLS_EMM_", fig_suffix, ".pdf"))
  if (requireNamespace("Cairo", quietly = TRUE)) {
    Cairo::CairoPDF(fig_path, width = 95/25.4, height = 85/25.4)
    print(p); dev.off()
  } else {
    ggsave(fig_path, plot = p, width = 95/25.4, height = 85/25.4, units = "in", device = "pdf")
  }
  cat("Saved:", fig_path, "\n")

  # --- Write per-tree outputs ---
  write.csv(emm_df,    file.path(out_dir, paste0("EMMs_", fig_suffix, ".csv")),            row.names = FALSE)
  write.csv(contr_df,  file.path(out_dir, paste0("PosthocContrasts_", fig_suffix, ".csv")),row.names = FALSE)
  write.csv(norm_tbl,  file.path(out_dir, paste0("Normality_", fig_suffix, ".csv")),       row.names = FALSE)
  write.csv(phy_tbl,   file.path(out_dir, paste0("PhyloSignal_", fig_suffix, ".csv")),     row.names = FALSE)
  write.csv(df,        file.path(out_dir, paste0("MatchedTraits_", fig_suffix, ".csv")),   row.names = FALSE)
  ape::write.tree(tree, file.path(out_dir, paste0("AnalysisTree_", fig_suffix, ".newick")))

  list(SummaryRow = si_summary, ModFull = mod_full, Tree = tree, Data = df)
}

###############################################################################
# 3) Run for both trees
###############################################################################
tree_cal <- read.tree(tree_calibrated_file)
tree_gra <- read.tree(tree_grafted_file)

cal <- align_tree_and_data(tree_cal, traits_raw)
gra <- align_tree_and_data(tree_gra, traits_raw)

res_cal <- run_pgls_analysis(cal$tree, cal$data, "Calibrated (119-tip)", "calibrated", out_dir)
res_gra <- run_pgls_analysis(gra$tree, gra$data, "Grafted (175-tip)",    "grafted",   out_dir)

###############################################################################
# 4) Cross-tree summary table (+ write)
###############################################################################
si_summary_both <- rbind(res_cal$SummaryRow, res_gra$SummaryRow)
write.csv(si_summary_both, file.path(out_dir, "PGLS_summary_both_trees.csv"), row.names = FALSE)
cat("\nWrote:", file.path(out_dir, "PGLS_summary_both_trees.csv"), "\n")

###############################################################################
# 5) Session info (reproducibility)
###############################################################################
writeLines(capture.output(sessionInfo()), file.path(out_dir, "sessionInfo.txt"))
cat("Wrote:", file.path(out_dir, "sessionInfo.txt"), "\n")

cat("\n=== Done ===\nOutputs (PDF, CSV, NEWICK) are in:\n", out_dir, "\n")
